<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reversi</title>
  <link rel="stylesheet" href="/reverse.css" />
  <!-- 既存CSSに依存せず確実に見えるよう、最低限のオーバーライドを追加 -->
  <style>
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; font-weight:600; }
    header .meta { font-weight:400; font-size:14px; opacity:.9 }
    #board { width:min(92vw,560px); margin:24px auto; }
    #toLobby { margin-left:16px; font-size:14px; }
    /* 汎用描画（既存reverse.cssが無効でも見えるように） */
    .row { display:flex; }
    .cell {
      position:relative; width:48px; height:48px; margin:2px; border-radius:8px; border:1px solid #0b0b0b;
      background:#2c7a2c; outline:none; cursor:pointer;
    }
    .cell[data-stone="white"]::after, .cell[data-stone="black"]::after {
      content:""; position:absolute; inset:20%; border-radius:50%;
      box-shadow: inset 0 0 4px rgba(0,0,0,.6);
    }
    .cell[data-stone="white"]::after { background:#eee; }
    .cell[data-stone="black"]::after { background:#111; }
    .cell[data-legal="1"]::before {
      content:""; position:absolute; inset:40%; border-radius:50%;
      border:2px solid #eee; box-shadow:0 0 0 1px #000;
    }
  </style>
</head>
<body>
  <header>
    <div style="font-size:28px;">Reversi</div>
    <div class="meta" id="meta">–</div>
  </header>

  <main><div id="board"></div></main>
  <nav style="text-align:center;margin:8px 0 24px;">
    <a href="#" id="toLobby">Lobby</a>
  </nav>

  <script>
  (() => {
    const params = new URLSearchParams(location.search);
    const room = parseInt(params.get('room') || '1', 10);
    const wantSeat = (params.get('seat') || 'observer').toLowerCase();
    const sseId = (crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

    const metaEl = document.getElementById('meta');
    const boardEl = document.getElementById('board');

    let playToken = sessionStorage.getItem('X-Play-Token') || '';
    let mySeat = 'observer';
    let snapshot = null;

    const SIZE = 8;

    function mapStoneCharToName(ch){
      // CSS互換のため 'W'|'B' を 'white'|'black' に変換（'-' は空）
      if (ch === 'W') return 'white';
      if (ch === 'B') return 'black';
      return '';
    }

    function renderBoard(snap){
      // 初回グリッド
      if (!boardEl.dataset.wired) {
        boardEl.innerHTML = '';
        for (let y=0; y<SIZE; y++){
          const row = document.createElement('div');
          row.className = 'row';
          for (let x=0; x<SIZE; x++){
            const cell = document.createElement('button');
            cell.className = 'cell'; cell.dataset.x = x; cell.dataset.y = y;
            cell.addEventListener('click', onCellClick);
            row.appendChild(cell);
          }
          boardEl.appendChild(row);
        }
        boardEl.dataset.wired = '1';
      }
      // 石＆合法手
      const stones = snap.board.stones;               // ["--------", ...]
      const legalSet = new Set((snap.legal||[]).map(s=>s.toLowerCase()));
      const xyToPos = (x,y)=> String.fromCharCode(97+x) + (y+1);

      for (let y=0; y<SIZE; y++){
        for (let x=0; x<SIZE; x++){
          const cell = boardEl.children[y].children[x];
          const ch = stones[y][x];                    // '-', 'W', 'B'
          const name = mapStoneCharToName(ch);        // '', 'white', 'black'
          if (name) cell.setAttribute('data-stone', name); else cell.removeAttribute('data-stone');

          const pos = xyToPos(x,y);
          const canPlay = legalSet.has(pos) && (mySeat === snap.turn);
          cell.setAttribute('data-legal', canPlay ? '1':'0');
        }
      }
      renderHeader(snap);
    }

    function renderHeader(snap){
      const seats = `Seats: Black ${snap.seats && snap.seats.black ? '✓':'–'} / White ${snap.seats && snap.seats.white ? '✓':'–'}`;
      const turn  = `Turn: ${snap.turn==='black'?'●':snap.turn==='white'?'○':'–'}`;
      const stat  = `Status: ${snap.status || 'waiting'}`;
      const watch = `Watching: ${snap.watchers ?? 0}`;
      const mine  = `You: ${mySeat}`;
      document.getElementById('meta').textContent = [seats, turn, stat, watch, mine].join('   ');
    }

    async function join(){
      const res = await fetch('/api/action', {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'join', room, seat: wantSeat, sse: sseId })
      });
      playToken = res.headers.get('X-Play-Token') || '';
      if (playToken) sessionStorage.setItem('X-Play-Token', playToken);
      snapshot = await res.json();
      mySeat = snapshot.seat || snapshot.mySeat || wantSeat;
      renderBoard(snapshot);
    }

    async function leave(){
      const body = JSON.stringify({ action:'leave', room, sse: sseId });
      try{
        await fetch('/api/action', {
          method:'POST', keepalive:true,
          headers: { 'Content-Type':'application/json', 'X-Play-Token': playToken || '' },
          body
        });
      }catch(_){}
      try{
        const blob = new Blob([body], {type:'application/json'});
        navigator.sendBeacon && navigator.sendBeacon('/api/action', blob);
      }catch(_){}
    }

    async function onCellClick(e){
      const cell = e.currentTarget;
      if (cell.getAttribute('data-legal') !== '1') return;
      const x = parseInt(cell.dataset.x,10), y = parseInt(cell.dataset.y,10);
      const pos = String.fromCharCode(97+x) + (y+1);
      const res = await fetch('/api/move', {
        method:'POST',
        headers: { 'Content-Type':'application/json', 'X-Play-Token': playToken || '' },
        body: JSON.stringify({ room, pos })
      });
      const snap = await res.json();
      snapshot = snap;
      renderBoard(snapshot);
    }

    // SSE: /sse に固定（Functionsの静的配信に干渉しない）
    let es = null;
    function openSSE(){
      if (es) es.close();
      const url = `/sse?room=${room}&seat=${mySeat}&sse=${encodeURIComponent(sseId)}`;
      es = new EventSource(url);
      es.addEventListener('room_state', (ev) => {
        try{
          const snap = JSON.parse(ev.data);
          snapshot = snap;
          if (snap.seat && snap.seat !== mySeat) mySeat = snap.seat; // 観戦fallback等
          renderBoard(snapshot);
        }catch(_){}
      });
    }

    document.getElementById('toLobby').addEventListener('click', async (e) => {
      e.preventDefault();
      await leave();
      location.href = '/index.html';
    });
    window.addEventListener('pagehide', leave);

    (async function boot(){
      await join();
      openSSE();
    })();
  })();
  </script>
</body>
</html>