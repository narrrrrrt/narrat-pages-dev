<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reversi Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <style>
    /* æ—¢å­˜ style.css å„ªå…ˆã€‚æœ€ä½é™ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã ã‘ */
    .room-grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:16px;margin:16px auto;max-width:800px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badges span{display:inline-block;border-radius:8px;padding:2px 8px;margin-left:6px;font-size:.85em;background:#f4f4f4}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:#666}
  </style>
</head>
<body>
  <h1 style="text-align:center;margin:16px 0">Reversi Lobby</h1>

  <div class="room-grid" id="rooms"></div>

  <script>
    // v1.1.3 ãƒ­ãƒ“ãƒ¼SSE: { rooms: [ {room,status,black,white,watchers, ... } ] } ã‚’æ­£ã¨ã™ã‚‹
    // â€» å¾Œæ–¹äº’æ›: æ—§1.0ã® blackVacant/whiteVacant, watching ãŒæ¥ãŸå ´åˆã ã‘è£œå®Œ
    const RNUMS = [1,2,3,4];
    const roomsEl = document.getElementById('rooms');

    // åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
    function ensureCards() {
      RNUMS.forEach(n => {
        if (document.getElementById(`room-${n}`)) return;
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `room-${n}`;
        card.innerHTML = `
          <div class="hdr">
            <strong>Room ${n}</strong>
            <div class="badges">
              <span id="r${n}-status" class="muted">waiting</span>
              <span id="r${n}-watch">ğŸ‘€ 0</span>
            </div>
          </div>
          <div class="btns">
            <button class="btn" id="r${n}-b" data-room="${n}" data-seat="black">â— Join (Black)</button>
            <button class="btn" id="r${n}-w" data-room="${n}" data-seat="white">â—‹ Join (White)</button>
            <a class="btn" id="r${n}-obs" href="/?seat=observer&room=${n}">Spectate</a>
          </div>
          <div class="muted" id="r${n}-hint"></div>
        `;
        roomsEl.appendChild(card);
      });
    }

    function setDisabled(id, disabled) {
      const el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // ã‚¯ãƒªãƒƒã‚¯ã§ /?seat=...&room=... ã¸ï¼ˆä»•æ§˜æº–æ‹ ï¼‰
    function wireJoinButtons() {
      roomsEl.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        const seat = t.getAttribute('data-seat');
        const room = t.getAttribute('data-room');
        if (!seat || !room) return;
        location.href = `/?seat=${seat}&room=${room}`;
      });
    }

    // å—ä¿¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§UIåæ˜ 
    function applySnapshotAll(data) {
      if (!data || !Array.isArray(data.rooms)) return;
      data.rooms.forEach(r => {
        const n = r.room;
        // v1.1 æ­£å¼ã‚­ãƒ¼
        let occupiedB = typeof r.black === 'boolean' ? r.black : undefined;
        let occupiedW = typeof r.white === 'boolean' ? r.white : undefined;
        let watchers  = typeof r.watchers === 'number' ? r.watchers : undefined;

        // æ—§1.0 äº’æ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ¬ è½æ™‚ã®ã¿è£œå®Œï¼‰
        if (occupiedB === undefined && 'blackVacant' in r) occupiedB = !r.blackVacant;
        if (occupiedW === undefined && 'whiteVacant' in r) occupiedW = !r.whiteVacant;
        if (watchers  === undefined && 'watching' in r)   watchers = r.watching;

        // UIæ›´æ–°
        setDisabled(`r${n}-b`, !!occupiedB);
        setDisabled(`r${n}-w`, !!occupiedW);
        setText(`r${n}-watch`, `ğŸ‘€ ${watchers ?? 0}`);
        setText(`r${n}-status`, r.status || 'waiting');

        // è£œåŠ©ãƒ’ãƒ³ãƒˆ
        const hint = document.getElementById(`r${n}-hint`);
        if (hint) {
          hint.textContent = `Black: ${occupiedB ? 'occupied' : 'vacant'} / White: ${occupiedW ? 'occupied' : 'vacant'}`;
        }
      });
    }

    // --- èµ·å‹• ---
    ensureCards();
    wireJoinButtons();

    // EventSource ã¯è‡ªå‹•ã§ Accept: text/event-stream ã‚’ä»˜ã‘ã‚‹
    const es = new EventSource('/?room=all');
    es.addEventListener('room_state', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        applySnapshotAll(data);
      } catch (e) {
        console.warn('parse room_state(all) failed', e);
      }
    });
    es.onerror = () => {
      // åˆ‡æ–­æ™‚ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†æ¥ç¶šã«ä»»ã›ã‚‹ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ã€‚ç‰¹åˆ¥ãªå‡¦ç†ã¯ä¸è¦ã€‚
      console.warn('lobby sse error');
    };
  </script>
</body>
</html>