<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reversi Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <style>
    /* 既存 style.css 優先。最低限のフォールバックだけ */
    .room-grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:16px;margin:16px auto;max-width:800px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .badges span{display:inline-block;border-radius:8px;padding:2px 8px;margin-left:6px;font-size:.85em;background:#f4f4f4}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:#666}
  </style>
</head>
<body>
  <h1 style="text-align:center;margin:16px 0">Reversi Lobby</h1>

  <div class="room-grid" id="rooms"></div>

  <script>
    // v1.1.3 ロビーSSE: { rooms: [ {room,status,black,white,watchers, ... } ] } を正とする
    // ※ 後方互換: 旧1.0の blackVacant/whiteVacant, watching が来た場合だけ補完
    const RNUMS = [1,2,3,4];
    const roomsEl = document.getElementById('rooms');

    // 初期カードを生成（存在しない場合のみ）
    function ensureCards() {
      RNUMS.forEach(n => {
        if (document.getElementById(`room-${n}`)) return;
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `room-${n}`;
        card.innerHTML = `
          <div class="hdr">
            <strong>Room ${n}</strong>
            <div class="badges">
              <span id="r${n}-status" class="muted">waiting</span>
              <span id="r${n}-watch">👀 0</span>
            </div>
          </div>
          <div class="btns">
            <button class="btn" id="r${n}-b" data-room="${n}" data-seat="black">● Join (Black)</button>
            <button class="btn" id="r${n}-w" data-room="${n}" data-seat="white">○ Join (White)</button>
            <a class="btn" id="r${n}-obs" href="/?seat=observer&room=${n}">Spectate</a>
          </div>
          <div class="muted" id="r${n}-hint"></div>
        `;
        roomsEl.appendChild(card);
      });
    }

    function setDisabled(id, disabled) {
      const el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // クリックで /?seat=...&room=... へ（仕様準拠）
    function wireJoinButtons() {
      roomsEl.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        const seat = t.getAttribute('data-seat');
        const room = t.getAttribute('data-room');
        if (!seat || !room) return;
        location.href = `/?seat=${seat}&room=${room}`;
      });
    }

    // 受信スナップショットでUI反映
    function applySnapshotAll(data) {
      if (!data || !Array.isArray(data.rooms)) return;
      data.rooms.forEach(r => {
        const n = r.room;
        // v1.1 正式キー
        let occupiedB = typeof r.black === 'boolean' ? r.black : undefined;
        let occupiedW = typeof r.white === 'boolean' ? r.white : undefined;
        let watchers  = typeof r.watchers === 'number' ? r.watchers : undefined;

        // 旧1.0 互換フィールド（欠落時のみ補完）
        if (occupiedB === undefined && 'blackVacant' in r) occupiedB = !r.blackVacant;
        if (occupiedW === undefined && 'whiteVacant' in r) occupiedW = !r.whiteVacant;
        if (watchers  === undefined && 'watching' in r)   watchers = r.watching;

        // UI更新
        setDisabled(`r${n}-b`, !!occupiedB);
        setDisabled(`r${n}-w`, !!occupiedW);
        setText(`r${n}-watch`, `👀 ${watchers ?? 0}`);
        setText(`r${n}-status`, r.status || 'waiting');

        // 補助ヒント
        const hint = document.getElementById(`r${n}-hint`);
        if (hint) {
          hint.textContent = `Black: ${occupiedB ? 'occupied' : 'vacant'} / White: ${occupiedW ? 'occupied' : 'vacant'}`;
        }
      });
    }

    // --- 起動 ---
    ensureCards();
    wireJoinButtons();

    // EventSource は自動で Accept: text/event-stream を付ける
    const es = new EventSource('/?room=all');
    es.addEventListener('room_state', (ev) => {
      try {
        const data = JSON.parse(ev.data);
        applySnapshotAll(data);
      } catch (e) {
        console.warn('parse room_state(all) failed', e);
      }
    });
    es.onerror = () => {
      // 切断時：ブラウザの自動再接続に任せる（指数バックオフ）。特別な処理は不要。
      console.warn('lobby sse error');
    };
  </script>
</body>
</html>