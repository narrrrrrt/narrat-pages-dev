<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reversi Lobby</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header class="header">
    <h1>Reversi Lobby</h1>
    <!-- デバッグ全初期化（?admin=1 の時だけ表示） -->
    <button id="debug-reset" style="display:none;margin-left:auto">Reset (ALL)</button>
  </header>

  <main id="lobby" class="lobby">
    <div id="boards" class="boards"></div>
    <p id="lobby-note" class="note" style="display:none;"></p>
  </main>

  <script>
    // ===== util =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // ===== ボードカード生成（Room1..4固定） =====
    const boardsHost = document.getElementById('boards');
    function makeCard(room){
      const wrap = document.createElement('section');
      wrap.className = 'board-card';
      wrap.setAttribute('data-room', String(room));
      wrap.innerHTML = `
        <h2>Room ${room}</h2>
        <div class="controls">
          <button class="seat btn" data-seat="black">Black</button>
          <button class="seat btn" data-seat="white">White</button>
          <button class="watch btn" data-seat="observer">Spectator</button>
        </div>
        <div class="meta"><span class="watchers">Watching: 0</span></div>
      `;
      // クリックで同一オリジンの /?room=..&seat=.. に遷移
      wrap.querySelectorAll('.seat').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const seat = btn.getAttribute('data-seat');
          location.href = `/?room=${room}&seat=${seat}`;
        });
      });
      const wbtn = wrap.querySelector('.watch');
      if (wbtn) {
        wbtn.addEventListener('click', ()=>{
          location.href = `/?room=${room}&seat=observer`;
        });
      }
      return wrap;
    }
    // 初期カード配置
    boardsHost.innerHTML = '';
    [1,2,3,4].forEach(n => boardsHost.appendChild(makeCard(n)));

    // ===== デバッグ：全初期化（?admin=1で表示） =====
    (function(){
      const showReset = new URL(location.href).searchParams.get('admin') === '1';
      const btn = document.getElementById('debug-reset');
      if (showReset) {
        btn.style.display = 'inline-block';
        btn.addEventListener('click', async ()=>{
          try {
            const res = await fetch('/api/admin', { method:'POST' });
            if (!res.ok) throw new Error();
            alert('Reset done.');
          } catch(e) { alert('Reset error'); }
        });
      }
    })();

    // ===== SSE: ロビーまとめ配信（/?room=all） =====
    (function(){
      const es = new EventSource('/?room=all', { withCredentials:false });
      const note = document.getElementById('lobby-note');

      es.addEventListener('open', ()=>{ note.style.display='none'; });

      es.addEventListener('error', ()=>{
        note.textContent = 'Reconnecting...';
        note.style.display = 'block';
      });

      es.addEventListener('room_state', ev=>{
        try{
          const msg = JSON.parse(ev.data);
          const boards = msg?.state?.boards || [];
          boards.forEach(b=>{
            const card = document.querySelector(`.board-card[data-room="${b.room}"]`);
            if (!card) return;
            // 座席ボタンの活性/非活性
            const blackBtn = card.querySelector('.seat[data-seat="black"]');
            const whiteBtn = card.querySelector('.seat[data-seat="white"]');
            if (blackBtn) blackBtn.disabled = (b.seats?.black === 'taken');
            if (whiteBtn) whiteBtn.disabled = (b.seats?.white === 'taken');
            // 観戦者数
            const w = card.querySelector('.watchers');
            if (w) w.textContent = `Watching: ${b.watchers ?? 0}`;
          });
        }catch(_){}
      });
    })();
  </script>
</body>
</html>